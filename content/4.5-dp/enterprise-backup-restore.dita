<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="topic_rr5_sv3_t5">
  <title>Enterprise Backup and Restore service</title><shortdesc>The <codeph>cbbackup</codeph> tool remains available both for the Community
    and Enterprise editions of Couchbase Server, but the new <term>Backup and Restore
      service</term> will be supported only for Couchbase Server Enterprise Edition.</shortdesc>
  <body>
  
    <p>The <xref
      href="http://developer.couchbase.com/documentation/server/4.1/cli/cbbackup-tool.html"
      format="html" scope="external">cbbackup</xref> tool enables you to back up a single node, a single bucket or
      the entire cluster into a flexible backup structure, which can restore the data into the same,
      or different, clusters and buckets. While <cmdname>cbbackup</cmdname> tool, combined with the
        <xref
        href="http://developer.couchbase.com/documentation/server/4.1/backup-restore/restore-cbrestore.html"
        format="html" scope="external">cbrestore</xref> tool, offers an easy and flexible solution
      to handle data including incremental backups, the new service is more convenient and efficient
      when handling large, multiple GB of data. </p>
    <note type="important">Use either <cmdname>cbbackup</cmdname> with <cmdname>cbrestore</cmdname>
      or the commands from the Backup and Restore tool (<cmdname>create</cmdname> and
        <cmdname>cluster</cmdname> with <cmdname>restore</cmdname>). The directory structure
      generated using <cmdname>cbbackup</cmdname> differs from the one generated using the Backup
      and Restore tool, and you cannot use these two tools interchangeably.</note>
    <p>By default, the Backup and Restore service performs incremental backups to back up only the
      new data. However, on a new cluster and for the first time this tool will produce a full
      backup. Each of the subsequent incremental backups will take a fraction of the time needed for
      the full backup.</p>
    
    <p>Backups are part of an overall Disaster Recovery Plan. For your applications and services, it
      is best to establish the <xref href="https://en.wikipedia.org/wiki/Recovery_time_objective"
        format="html" scope="external">Recovery Time Objective</xref> (RTO) and <xref
        href="https://en.wikipedia.org/wiki/Recovery_point_objective" format="html" scope="external"
        >Recovery Point Objective</xref> (RPO) periods as part of that plan. It is recommended that
      you familiarize yourself with how backups fit as a part of an overall Disaster Recovery Plan. </p>
    <note type="note">Only the full Couchbase administrators can use the Backup and Restore service to back up
      and restore data.</note>
    
    <section><title>Backup archive</title>
    <p>The backup archive is a directory that contains a set of backup repositories as well as logs
        for the backup client. The backup directory should be modified only by the backup client,
        and any modifications that are not done by that client might result in a corruption of
        backup data. </p>
    <p>Only one backup client can access the backup archive at one time. If multiple instances of
        the backup client are running on the same archive at the same time, this might result in
        corruption. To prevent such corruption instances, you may be required to create multiple
        backup archives depending on your use case. </p></section> 
    <section><title>How the Backup and Restore service works</title>
    <p>The Backup and Restore service is installed as a part of the Couchbase Server Enterprise Edition package.</p>
      
      <p>Here are the steps to follow to perform a simple, quick backup of a specific bucket across
        all nodes of the cluster:</p> 
      <dl>
        <dlentry>
          <dt>Create an archive repository with the command <cmdname>create</cmdname>:</dt>
          <dd>If that directory does not exist, the backup utility will attempt to create it:
            <codeblock>./backup create --dir=[directory-name] --name=[repository-name] --host=[hostname] \
--username [admin] --password [password]</codeblock></dd>
        </dlentry></dl>
        
      <dl>
        <dlentry>
          <dt>Back up data with the command <cmdname>cluster</cmdname>:</dt>    
           <dd>Only full Couchbase administrators can perform backups using their credentials. <p>On
              Linux and Mac OS:
              <codeblock>$> ./backup cluster --dir=/tmp/backups --name=travel --host=http://localhost:8091 \
--username=MyAdminUsername --password=MyAdminPassword </codeblock></p><p>On
              Windows:
              <codeblock>C:\> backup cluster --dir=C:\tmp\backups\travel --name=travel --host=http://localhost:8091 \
--username=MyAdminUsername --password=MyAdminPassword</codeblock></p></dd>
       <dd>The output of these commands will look similar to the following: <p><image
                href="pict/backup-output.png" id="image_hqm_kmb_y5"/>
            </p></dd></dlentry></dl>
      <dl>
        <dlentry>
          <dt>Merge backups wit the command <cmdname>merge</cmdname></dt>
          <dd>When you merge incremental backups, you free up disk space avoid running full backups
            significantly reducing the amount of time needed to back up a  cluster. <p>Specify the
              starting and ending backups that you want  to merge. </p>
            <!--<p>The current backup names can be found by running the list command on your
              backup archive. </p>-->
            <p>The <cmdname>merge</cmdname> command first copies the oldest backup to be merged to a
              special <codeph>.merge</codeph> directory. Data from each subsequent incremental
              backup directory, which is a part of the merge, is then copied in this directory. Once
              all of the data has been merged in the <codeph>.merge</codeph> directory, the old
              backups are deleted from the backup archive and the <codeph>.merge</codeph> directory
              is renamed to the backup specified in the <codeph>--end</codeph> argument.
              </p><p>Merging of backups is fault-tolerant, and data loss is not possible even if the
              backup tool crashes: there is a <codeph>.merge_status </codeph>file that records the
              last completed step of the process and which incremental backups are supposed to be
              merged. If a merge fails to complete, the backup tool will detect an incomplete merge
              and revert it.</p><p>To merge several backups together:
              <codeblock>./backup merge --dir /tmp/backups --name travel --start 2016-01-22T15:42:41.383468246-08:00 \
--end 2016-01-22T15:42:41.383468246-08:00</codeblock></p>
          </dd>
        </dlentry>
      </dl>     
      <dl>
        <dlentry>
          <dt>Restore data with the command <cmdname>restore</cmdname></dt>
          <dd>Only full Couchbase administrators can perform restores using their credentials.
              <p>First decide which backups you want to restore. Use the <codeph>--start</codeph>
              and <codeph>--end</codeph> flags to specify the backups. If the
                <codeph>--start</codeph> flag is not specified, it defaults to the first backup
              taken. If the --end flag is not specified, it defaults to the last flag taken. If you
              want to start or end from a different backup, specify the name of the backup for one
              or both of these flags. </p><p>If you want to start or end from a different backup,
              specify the name of the backup for one or both of these flags. </p>To restore all
            backups in the backup repository <codeph>travel</codeph>: <p>On Linux and Mac OS:
              <codeblock>$> ./backup restore --dir=/tmp/backups/travel --name=travel-sample --host=http://localhost:8091 \
 --username=MyAdminUsername --password=MyAdminPassword </codeblock></p><p>On
              Windows:
              <codeblock>C:\> backup restore --dir=C:\tmp\backups\travel --name=travel-sample --host=http://localhost:8091 \
--username=MyAdminUsername --password=MyAdminPassword </codeblock></p></dd>
        </dlentry>
      </dl>
  <dl>
    <dlentry>
      <dt>Compact data with the command <cmdname>compact</cmdname></dt>
      <dd>Compact the data of an incremental backup and after the backup has completed:
            <codeblock>./backup compact --dir /tmp/backups --name travel --incr-backup 2016-01-22T15:42:41.383468246-08:00</codeblock></dd>
    </dlentry>
  </dl>    
   
   <dl>
     <dlentry>
       <dt>Remove backups from the backup archive with the command <cmdname>remove</cmdname></dt>
       <dd>Remove a backup from the backup archive. Make sure the data is no longer needed!
            <codeblock>./backup remove --dir /tmp/backups --name travel</codeblock></dd>
     </dlentry>
   </dl> 
    
    
    </section>
    
   
  
  </body>
</topic>
