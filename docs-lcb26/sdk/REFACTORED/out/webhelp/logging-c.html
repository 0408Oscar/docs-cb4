
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
<head><meta name="description" content="Library logging The C SDK offers a basic logging facility through which its various subsystems can output debug and error information. This information provides details of the library's internals and ..."></meta><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><meta name="copyright" content="(C) Copyright 2005"></meta><meta name="DC.rights.owner" content="(C) Copyright 2005"></meta><meta name="DC.Type" content="concept"></meta><meta name="DC.Title" content="Logging"></meta><meta name="DC.Relation" scheme="URI" content="exceptions-diagnostics-toplevel.html"></meta><meta name="DC.Format" content="XHTML"></meta><meta name="DC.Identifier" content="concept_ff3_2jq_44"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>Logging</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/skins/skin.css"><!----></link><script type="text/javascript"><!--
          
          var prefix = "index.html";
          
          --></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-1.8.2.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script></head>
<body onload="highlightSearchTerm()" class="frmBody" id="concept_ff3_2jq_44">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><a href="javascript:window.print();" title="Print this page"></a></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td width="75%"><a class="navheader_parent_path" href="exceptions-diagnostics-toplevel.html" title="Errors and Diagnostics">Errors and Diagnostics</a></td><td><div class="navheader">
<span class="navparent"><a class="link" href="exceptions-diagnostics-toplevel.html" title="Errors and Diagnostics"><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Errors and Diagnostics</span></a></span>  </div></td></tr></tbody></table>

 <h1 class="title topictitle1">Logging</h1>

 <div class="body conbody">
        <div class="section"><h2 class="title sectiontitle">Library logging</h2><p class="p">The C SDK offers a basic logging facility through
                which its various subsystems can output debug and error information. This
                information provides details of the library's internals and additional error
                information which may otherwise not be accessible via other APIs. Logging may be
                enabled using environment variables, a connection string directive, or
                    <span class="keyword apiname">lcb_cntl</span></p>
<div class="p">The most common way to enable logging is to
                set the <samp class="ph codeph">LCB_LOGLEVEL</samp> environment variable to a number between 1 and
                5, with 5 being the most verbose and 1 being the least verbose. Note that the client
                logs will go to standard
                error:<pre class="pre codeblock">shell$ LCB_LOGLEVEL=5 ./my_couchbase_app</pre>
</div>
<p class="p">The
                default logger can also be enabled programmatically via the
                    <samp class="ph codeph">LCB_CNTL_CONLOGGER_LEVEL</samp> setting or the
                    <samp class="ph codeph">console_log_level</samp> option in the connection string.</p>
<p class="p">If
                you wish to control where the logs are output or what information is displayed
                (beyond basic verbosity filtering) you can install a logging callback via the
                    <samp class="ph codeph">LCB_CNTL_LOGGER</samp> setting.</p>
<p class="p">If you wish to change the actual
                destination of the logs (for example, log to a file) you may set the
                    <samp class="ph codeph">console_log_file</samp> directive in the connection string.</p>
When
            logging is turned on, the library will output messages similar to
                this:<pre class="pre codeblock">1ms [I0] {14780} [DEBUG] (lcbio_mgr - L:383) &lt;localhost:11210&gt; (HE=0xe56760) 
Creating new connection because none are available in the pool</pre>
<div class="note note"><span class="notetitle">Note:</span> The
                output format is subject to change. It is intended for human consumption and is not
                designed to be parseable.</div>
<p class="p">The following table describes the components of
                the log entries:</p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="concept_ff3_2jq_44__table_jnv_fv4_p4" class="table" frame="border" border="1" rules="all">
                    
                    
                    <thead class="thead" align="left">
                        <tr class="row">
                            <th class="entry" valign="top" width="19.011406844106464%" id="d3470e63">Format</th>

                            <th class="entry" valign="top" width="80.98859315589354%" id="d3470e66">Description</th>

                        </tr>

                    </thead>

                    <tbody class="tbody">
                        <tr class="row">
                            <td class="entry" valign="top" width="19.011406844106464%" headers="d3470e63 "><samp class="ph codeph"><em class="ph i">n</em>ms</samp></td>

                            <td class="entry" valign="top" width="80.98859315589354%" headers="d3470e66 ">The number of milliseconds elapsed since the loading of the
                                library</td>

                        </tr>

                        <tr class="row">
                            <td class="entry" valign="top" width="19.011406844106464%" headers="d3470e63 "><samp class="ph codeph">[I<em class="ph i">n</em>]</samp></td>

                            <td class="entry" valign="top" width="80.98859315589354%" headers="d3470e66 ">The identifier of the <samp class="ph codeph">lcb_t</samp> object associated
                                with the current message. This allows you to determine the origin of
                                the message in the case where the application contains multiple such
                                    <samp class="ph codeph">lcb_t</samp> objects. The number is incremented for
                                each call to <span class="keyword apiname">lcb_create()</span></td>

                        </tr>

                        <tr class="row">
                            <td class="entry" valign="top" width="19.011406844106464%" headers="d3470e63 "><samp class="ph codeph">{<em class="ph i">PID</em>}</samp></td>

                            <td class="entry" valign="top" width="80.98859315589354%" headers="d3470e66 ">The current thread/process identifier. On Linux this is also the
                                process ID for single-threaded programs, further helping distinguish
                                between multiple forks of an application.</td>

                        </tr>

                        <tr class="row">
                            <td class="entry" valign="top" width="19.011406844106464%" headers="d3470e63 "><samp class="ph codeph">[<em class="ph i">LEVEL</em>]</samp></td>

                            <td class="entry" valign="top" width="80.98859315589354%" headers="d3470e66 ">A string representing the severity of the level</td>

                        </tr>

                        <tr class="row">
                            <td class="entry" valign="top" width="19.011406844106464%" headers="d3470e63 "><samp class="ph codeph">(<em class="ph i">subsystem</em> - L:<em class="ph i">line</em>)</samp></td>

                            <td class="entry" valign="top" width="80.98859315589354%" headers="d3470e66 ">The <em class="ph i">subsystem</em> that produced this message, followed by the
                                source code line at which this message was created. The subsystem
                                will typically, but not always, resemble the source code file. It is
                                a small string describing what the current line is doing.</td>

                        </tr>

                        <tr class="row">
                            <td class="entry" valign="top" width="19.011406844106464%" headers="d3470e63 "><samp class="ph codeph">&lt;<em class="ph i">host:port</em>&gt;</samp></td>

                            <td class="entry" valign="top" width="80.98859315589354%" headers="d3470e66 ">The host and port, if any, associated with the message. This is
                                supplied for messages that relate to the state of a particular
                                connection.</td>

                        </tr>

                    </tbody>

                </table>
</div>
</div>

        <div class="section"><h2 class="title sectiontitle">Getting stack traces</h2>
            
            <div class="p"><div class="note note"><span class="notetitle">Note:</span> The following section applies to Linux, Mac OS X, and other Unix-like
                    systems.</div>
Stack traces and core dumps may be required if your application
                is hanging or crashing. In this case knowing in which location the library (or
                application) is misbehaving becomes useful.</div>

            <p class="p">To get a stack trace you need to have <a class="xref" href="http://www.gnu.org/software/gdb/" target="_blank">GDB</a> installed on your machine and be
                familiar with its use. If you cannot run your application from within GDB, you can
                attach GDB to an existing process.</p>

            <p class="p">To generate a useful stack trace, you need to run your application with a debug build
                of the Couchbase C library because the released binaries are optimized. During
                optimization the compiler might rearrange the code, which can result in misleading
                source file and line number information in the stack trace. </p>

            <p class="p">To make a debug build of the C library, build the library yourself from source with
                the <samp class="ph codeph">‑‑enable‑debug</samp> option applied to the
                    <samp class="ph codeph">configure</samp> script, as shown in the following example:</p>

            <pre class="pre codeblock language-bash">mnunberg@mbp15 ~/Source/libcouchbase $ ./cmake/configure --enable-debug
Detected in-source build. Making 'build' directory
cmake ../ \
    "-DCMAKE_BUILD_TYPE=DEBUG" \
    "-DCMAKE_INSTALL_PREFIX=/usr/local" \
    "-GUnix Makefiles" \
# SNIP</pre>

            <p class="p">Ensure debugging symbols for the C client are installed. If you are using a binary
                distribution, use your package manager to install the
                    <samp class="ph codeph">libcouchbase-dbg</samp> or <samp class="ph codeph">libcouchbase-debuginfo</samp>
                package. If you are using a version of the C library built from source, ensure that
                    <samp class="ph codeph">‑‑enable‑debug</samp> was passed to the
                    <samp class="ph codeph">configure</samp> script. </p>

            <p class="p">You should also build your application with debug symbols, though not strictly
                required.</p>

            <p class="p">If your application crashes within the C library, examine the stack trace
                information. The C library is asynchronous in its core, so almost everything happens
                from within the <span class="keyword apiname">lcb_wait()</span> function. Tracing actual state changes
                and events within the library is only possible by using <a class="xref" href="logging-c.html#concept_ff3_2jq_44">logging</a>.</p>

            <p class="p">The following example shows how to run an application from GDB and how to get a stack
                trace when it crashes:</p>

            <pre class="pre codeblock language-bash">mnunberg@mbp15 ~/Source/libcouchbase/build $ gdb --args ./bin/cbc cat foo -U couchbase://192.168.33.101/default
# SNIP
(gdb) r
Starting program: /Users/mnunberg/Source/libcouchbase/build/bin/cbc cat foo -U couchbase://192.168.33.101/default
Reading symbols for shared libraries .
# SNIP
Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_INVALID_ADDRESS at address: 0x0000000000000020
0x00000001000bacb9 in try_read (ctx=0x100703760, server=0x100700660, ior=0x1007037a8) at /Users/mnunberg/Source/libcouchbase/src/mcserver/mcserver.c:198
198	        pl2-&gt;index++;
(gdb) thread apply all bt

Thread 1 (process 7377):
#0  0x00000001000bacb9 in try_read (ctx=0x100703760, server=0x100700660, ior=0x1007037a8) at /Users/mnunberg/Source/libcouchbase/src/mcserver/mcserver.c:198
#1  0x00000001000baa29 in on_read (ctx=0x100703760, nb=31) at /Users/mnunberg/Source/libcouchbase/src/mcserver/mcserver.c:299
#2  0x0000000100090935 in invoke_read_cb (ctx=0x100703760, nb=31) at /Users/mnunberg/Source/libcouchbase/src/lcbio/ctx.c:273
#3  0x0000000100090a23 in E_handler (sock=4, which=2, arg=0x100703760) at /Users/mnunberg/Source/libcouchbase/src/lcbio/ctx.c:290
#4  0x000000010030d422 in event_base_loop ()
#5  0x00000001003068e1 in lcb_io_run_event_loop (iops=0x100405e50) at /Users/mnunberg/Source/libcouchbase/plugins/io/libevent/plugin-libevent.c:202
#6  0x00000001000c1d4d in lcb_wait (instance=0x100405910) at /Users/mnunberg/Source/libcouchbase/src/wait.c:88
#7  0x0000000100003be9 in cbc::GetHandler::run (this=0x100801200) at /Users/mnunberg/Source/libcouchbase/tools/cbc.cc:317
#8  0x000000010000318f in cbc::Handler::execute (this=0x100801200, argc=4, argv=0x7fff5fbffac8) at /Users/mnunberg/Source/libcouchbase/tools/cbc.cc:219
#9  0x000000010000e93c in main (argc=4, argv=0x7fff5fbffac8) at /Users/mnunberg/Source/libcouchbase/tools/cbc.cc:1204
</pre>

        </div>

        <div class="section"><h2 class="title sectiontitle">Detecting invalid memory accesses</h2>
            
            <p class="p"><a class="xref" href="http://valgrind.org" target="_blank">Valgrind</a> can
                help you detect issues in your application (or the library itself) related to
                accessing invalid (already freed or unallocated) memory or uninitialized memory
                regions. This information is useful when debugging application behavior before a
                crash because crashes are often caused by entering a normally impossible state
                induced by a previous write or read to an invalid memory location.</p>

            <p class="p">You can install Valgrind through your package manager.</p>

            <p class="p">Valgrind will slow down execution time significantly, often by a factor of 20x. To
                lessen this impact on an application that performs lots of load, temporarily reduce
                the amount of CPU it uses.</p>

            <p class="p"> Valgrind typically does not work well with dynamic language interpreters such as
                Python, Ruby, or Perl due to the way these languages optimize memory allocation. To
                effectively use Valgrind with these languages, you often need to use a special debug
                build of the interpreter. To find out more about using Valgrind with interpreters,
                refer to the documentation for the language you are using.</p>

            <p class="p">The following example shows how to run an application with Valgrind. In the example,
                the operation appears to time out, but the real cause of the problem is
                uninitialized memory access that causes the client to incorrectly read the response
                from the server.</p>

            <pre class="pre codeblock">mnunberg@csure:/sources/libcouchbase/build$ valgrind ./bin/cbc cat foo -U couchbase://192.168.33.101/default
==29887== Memcheck, a memory error detector
==29887== Copyright (C) 2002-2011, and GNU GPL'd, by Julian Seward et al.
==29887== Using Valgrind-3.7.0 and LibVEX; rerun with -h for copyright info
==29887== Command: ./bin/cbc cat foo -U couchbase://192.168.33.101/default
==29887== 
==29887== Conditional jump or move depends on uninitialised value(s)
==29887==    at 0x4E6D801: try_read (mcserver.c:221)
==29887==    by 0x4E6DD64: on_read (mcserver.c:294)
==29887==    by 0x4E4B8AA: invoke_read_cb (ctx.c:273)
==29887==    by 0x4E4B92B: E_handler (ctx.c:290)
==29887==    by 0x6E55EEB: event_base_loop (in /usr/lib/x86_64-linux-gnu/libevent_core-2.0.so.5.1.7)
==29887==    by 0x6C49610: lcb_io_run_event_loop (plugin-libevent.c:202)
==29887==    by 0x4E73D75: lcb_wait (wait.c:88)
==29887==    by 0x410964: cbc::GetHandler::run() (cbc.cc:317)
==29887==    by 0x41036F: cbc::Handler::execute(int, char**) (cbc.cc:219)
==29887==    by 0x414E03: main (cbc.cc:1204)
==29887== 
==29887== Conditional jump or move depends on uninitialised value(s)
==29887==    at 0x4E4BF07: E_schedule (ctx.c:447)
==29887==    by 0x4E4BFD4: lcbio_ctx_schedule (ctx.c:471)
==29887==    by 0x4E4BA21: E_handler (ctx.c:320)
==29887==    by 0x6E55EEB: event_base_loop (in /usr/lib/x86_64-linux-gnu/libevent_core-2.0.so.5.1.7)
==29887==    by 0x6C49610: lcb_io_run_event_loop (plugin-libevent.c:202)
==29887==    by 0x4E73D75: lcb_wait (wait.c:88)
==29887==    by 0x410964: cbc::GetHandler::run() (cbc.cc:317)
==29887==    by 0x41036F: cbc::Handler::execute(int, char**) (cbc.cc:219)
==29887==    by 0x414E03: main (cbc.cc:1204)
==29887== 
foo                  Client-Side timeout exceeded for operation. Inspect network conditions or increase the timeout (0x17)
==29887== Conditional jump or move depends on uninitialised value(s)
==29887==    at 0x4E4B4EB: lcbio_ctx_close_ex (ctx.c:156)
==29887==    by 0x4E4B640: lcbio_ctx_close (ctx.c:192)
==29887==    by 0x4E6EFB8: finalize_errored_ctx (mcserver.c:720)
==29887==    by 0x4E6EEE3: start_errored_ctx (mcserver.c:698)
==29887==    by 0x4E6ED98: mcserver_close (mcserver.c:646)
==29887==    by 0x4E6A943: lcb_destroy (instance.c:491)
==29887==    by 0x41020C: cbc::Handler::~Handler() (cbc.cc:208)
==29887==    by 0x42222D: cbc::GetHandler::~GetHandler() (in /sources/lcb-packet-ng/build/bin/cbc)
==29887==    by 0x422297: cbc::GetHandler::~GetHandler() (cbc-handlers.h:31)
==29887==    by 0x414E3D: main (cbc.cc:1221)
==29887== 
==29887== 
==29887== HEAP SUMMARY:
==29887==     in use at exit: 4,994 bytes in 20 blocks
==29887==   total heap usage: 602 allocs, 582 frees, 588,374 bytes allocated
==29887== 
==29887== LEAK SUMMARY:
==29887==    definitely lost: 35 bytes in 1 blocks
==29887==    indirectly lost: 0 bytes in 0 blocks
==29887==      possibly lost: 28 bytes in 1 blocks
==29887==    still reachable: 4,931 bytes in 18 blocks
==29887==         suppressed: 0 bytes in 0 blocks
==29887== Rerun with --leak-check=full to see details of leaked memory
==29887== 
==29887== For counts of detected and suppressed errors, rerun with: -v
==29887== Use --track-origins=yes to see where uninitialised values come from
==29887== ERROR SUMMARY: 3 errors from 3 contexts (suppressed: 10 from 6)</pre>

        </div>

        <div class="section"><h2 class="title sectiontitle">Getting core dumps</h2>
            
            <p class="p">Core dumps might be generated when an application crashes (though on many systems
                core file generation is off by default). The core dump contains a memory dump of
                your application that can be inspected on a different system. This lets you inspect
                the state of the library to determine what the error was at the time of the
                crash.</p>

            <p class="p">Core dumps can only be analyzed if the binaries that generated them are accessible
                and have debugging symbols. Binaries in this sense includes the client library, the
                application, and any other shared libraries loaded by the application. This means
                that the platform (and distribution) that generated the core dump must be available
                and loadable (or at least reproducible) when analyzing the core dump.</p>

            <div class="note warning"><span class="warningtitle">Warning:</span> A core file contains the memory contents of your application.
                Anyone who can read your core file can access potentially sensitive data that your
                application was processing at the time of the crash. If possible, have your
                application operate on sample data.</div>

            <p class="p">To get a core dump:</p>

            <ol class="ol" id="concept_ff3_2jq_44__ol_h5z_vbl_gv">
                <li class="li">
                    <p class="p">Invoke <samp class="ph codeph">ulimit -c unlimited</samp> in the same shell that your
                        application will run (or a parent thereof) prior to the invocation of that
                        application. The <samp class="ph codeph">ulimit</samp> command instructs the kernel to
                        generate core dump files for all subsequent processes that terminate
                        abnormally and are executed within the current shell or any child shell.</p>

                </li>

                <li class="li">
                    <p class="p">Ensure you are either using a binary installation of the client library
                        (which was installed from an official Couchbase repository) or are using a
                        source build with debug symbols enabled.</p>

                </li>

                <li class="li">
                    <p class="p">When the application crashes, a core file is created. The exact location and
                        name of the file is dependent on the specific kernel configuration. For more
                        information about where core files are located, see <a class="xref" href="http://stackoverflow.com/questions/2065912/core-dumped-but-core-file-is-not-in-current-directory" target="_blank">http://stackoverflow.com/questions/2065912/core-dumped-but-core-file-is-not-in-current-directory</a>.</p>

                </li>

                <li class="li">
                    <p class="p">Compress the core file using <span class="keyword cmdname">gzip</span> or a similar utility
                        before submitting to support. Compressing the file makes the upload and
                        download times quicker for analyzing the core file.</p>

                </li>

                <li class="li">
                    <p class="p">Disable core dumps once completed. Core dumps are disabled by default on most
                        Linux distributions because they may potentially write sensitive information
                        to disk and many core dump files can quickly fill up a file system.</p>

                </li>

            </ol>

            <p class="p">The following example shows how to enable and collect a core dump:</p>

            <pre class="pre codeblock language-java">mnunberg<em><span class="hl-annotation" style="color: gray">@csure:/sources/libcouchbase/build$</span></em> ulimit -c unlimited
mnunberg<em><span class="hl-annotation" style="color: gray">@csure:/sources/libcouchbase/build$</span></em> ./bin/cbc cat foo -U couchbase:<em class="hl-comment" style="color:#006400">//192.168.33.101</em>
Aborted (core dumped)
# Showing the effects of compressing the core file:
mnunberg<em><span class="hl-annotation" style="color: gray">@csure:/sources/libcouchbase/build$</span></em> ls -lsh core 
<span class="hl-number">961</span>K -rw------- <span class="hl-number">1</span> mnunberg mnunberg <span class="hl-number">1.3</span>M Nov <span class="hl-number">21</span> <span class="hl-number">12</span>:<span class="hl-number">53</span> core
mnunberg<em><span class="hl-annotation" style="color: gray">@csure:/sources/libcouchbase/build$</span></em> gzip core 
mnunberg<em><span class="hl-annotation" style="color: gray">@csure:/sources/libcouchbase/build$</span></em> ls -lsh core.gz 
<span class="hl-number">136</span>K -rw------- <span class="hl-number">1</span> mnunberg mnunberg <span class="hl-number">133</span>K Nov <span class="hl-number">21</span> <span class="hl-number">12</span>:<span class="hl-number">53</span> core.gz</pre>

        </div>

  </div>

<div class="related-links"></div>
<div class="navfooter"><!---->
<span class="navparent"><a class="link" href="exceptions-diagnostics-toplevel.html" title="Errors and Diagnostics"><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Errors and Diagnostics</span></a></span>  </div><div class="footer">WebHelp output generated by<a href="http://www.oxygenxml.com" target="_blank"><span class="oXygenLogo"><img src="oxygen-webhelp/resources/img/LogoOxygen100x22.png" alt="Oxygen"></img></span><span class="xmlauthor">XML Author</span></a> - Trial Edition</div>
</body>
</html>