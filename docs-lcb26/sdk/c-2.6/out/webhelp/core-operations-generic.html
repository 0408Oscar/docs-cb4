
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
<head><meta name="description" content="CRUD Operations At the core of Couchbase is the key-value store, which provides the basic operations: upsert(docid, document) insert(docid, document) replace(docid, document) get(docid) remove(docid) ..."></meta><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><meta name="copyright" content="(C) Copyright 2005"></meta><meta name="DC.rights.owner" content="(C) Copyright 2005"></meta><meta name="DC.Type" content="topic"></meta><meta name="DC.Title" content="Core Operations"></meta><meta name="DC.Relation" scheme="URI" content="managing-data.html"></meta><meta name="DC.Format" content="XHTML"></meta><meta name="DC.Identifier" content="devguide_kvcore_generic"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>Core Operations</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/skins/skin.css"><!----></link><script type="text/javascript"><!--
          
          var prefix = "index.html";
          
          --></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-1.8.2.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script></head>
<body onload="highlightSearchTerm()" class="frmBody" id="devguide_kvcore_generic">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><a href="javascript:window.print();" title="Print this page"></a></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td width="75%"><a class="navheader_parent_path" href="c-intro.html" title="C SDK 2.6">C SDK 2.6</a> / <a class="navheader_parent_path" href="managing-data.html" title="Managing Data">Managing Data</a></td><td><div class="navheader">
<span class="navparent"><a class="link" href="managing-data.html" title="Managing Data"><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Managing Data</span></a></span>  </div></td></tr></tbody></table>

  <h1 class="title topictitle1">Core Operations</h1>

  <div class="body">
        <div class="section"><h2 class="title sectiontitle">CRUD Operations</h2>
            
            <div class="p">At the core of Couchbase is the key-value store, which provides the basic
                operations:<pre class="pre codeblock">upsert(docid, document)
insert(docid, document)
replace(docid, document)
get(docid)
remove(docid)</pre>
</div>

            <p class="p">In Couchbase, documents are stored using one of the <em class="ph i">upsert</em>, <em class="ph i">insert</em>, and
                    <em class="ph i">replace</em> operations. These operations will all write a JSON document with
                a given document ID (key) to the database. The update methods differ in behavior in
                respect to the existing state of the document:</p>

            <ul class="ul" id="devguide_kvcore_generic__ul_wjj_zlm_zs">
                <li class="li"><em class="ph i">insert</em> will only create the document if the given ID is not found within
                    the database.</li>

                <li class="li"><em class="ph i">replace</em> will only replace the document if the given ID already exists
                    within the database.</li>

                <li class="li"><em class="ph i">upsert</em> will always replace the document, ignoring whether the ID has
                    already existed or not.</li>

            </ul>

            <p class="p">Documents can be retrieved using the <em class="ph i">get</em> operation, and finally removed using
                the <em class="ph i">remove</em> operation.</p>

            <p class="p">Since Couchbase’s KV store may be thought of as a distributed hashmap or dictionary,
                the following code samples are explanatory of Couchbase’ update operations:</p>

            <pre class="pre codeblock language-python">KV_STORE = {}

<strong class="hl-keyword" style="color:#7f0055">def</strong> insert(doc_id, value):
    <strong class="hl-keyword" style="color:#7f0055">if</strong> doc_id <strong class="hl-keyword" style="color:#7f0055">not</strong> <strong class="hl-keyword" style="color:#7f0055">in</strong> KV_STORE:
        KV_STORE[doc_id] = value
    <strong class="hl-keyword" style="color:#7f0055">else</strong>:
        <strong class="hl-keyword" style="color:#7f0055">raise</strong> KeyAlreadyExists()

<strong class="hl-keyword" style="color:#7f0055">def</strong> replace(doc_id, value):
    <strong class="hl-keyword" style="color:#7f0055">if</strong> doc_id <strong class="hl-keyword" style="color:#7f0055">in</strong> KV_STORE:
        KV_STORE[doc_id] = value
    <strong class="hl-keyword" style="color:#7f0055">else</strong>:
        <strong class="hl-keyword" style="color:#7f0055">raise</strong> KeyNotFound()

<strong class="hl-keyword" style="color:#7f0055">def</strong> upsert(doc_id, value):
    KV_STORE[doc_id] = value

<strong class="hl-keyword" style="color:#7f0055">def</strong> get(doc_id):
    <strong class="hl-keyword" style="color:#7f0055">if</strong> doc_id <strong class="hl-keyword" style="color:#7f0055">in</strong> KV_STORE:
        <strong class="hl-keyword" style="color:#7f0055">return</strong> KV_STORE[doc_id]
    <strong class="hl-keyword" style="color:#7f0055">else</strong>:
        <strong class="hl-keyword" style="color:#7f0055">raise</strong> KeyNotFound()

<strong class="hl-keyword" style="color:#7f0055">def</strong> delete(doc_id):
    <strong class="hl-keyword" style="color:#7f0055">del</strong> KV_STORE[doc_id]</pre>

        </div>

        <div class="section"><h2 class="title sectiontitle">Document</h2>
            
            <p class="p">A document refers to an entry within the database (other databases mamy refer to the
                same concept as a "row"). A document has an ID (other databases may call this a
                "primary key"). by which it can be located (and is unique to the document) and a
                value which contains the actual application data.</p>

            <div class="p"><strong class="ph b">Document IDs</strong> are assigned by application. A valid document ID must:<ul class="ul" id="devguide_kvcore_generic__ul_rht_rnm_zs">
                    <li class="li">Conform to UTF-8 encoding</li>

                    <li class="li">Be no longer than 250 bytes<div class="note note"><span class="notetitle">Note:</span> Note the difference between bytes and
                            characters. Most non-Latin characters occupy more than a single
                            byte</div>
</li>

                </ul>
You are free to choose any ID for your document, so long as they conform to the
                above restrictions. Unlike some other database, Couchbase does not automatically
                generate IDs for you (but see [counter pattern]).</div>

            <p class="p">The <strong class="ph b">document value</strong> contains the actual application data, for example a
                    <em class="ph i">product</em> document may contain information about the price and description.
                Documents are usually (<a class="xref" href="google.cmo" target="_blank">but not
                    always</a>) stored as JSON on the server. Because JSON is a low overhead
                structured format, it can be subsequently searched and queried.</p>

        </div>

        <div class="section"><h2 class="title sectiontitle">Storing documents</h2>
            
            <p class="p">Documents can be stored using either the SDK, Command line, or Web UI. When using a
                storage operation, the <em class="ph i">entire contents</em> of the document are replaced with the
                newly supplied document.</p>

            <p class="p">The following example shows a document being stored using the <samp class="ph codeph">cbc</samp>
                utility. The ID of the document is <samp class="ph codeph">docid</samp> and its value is JSON
                containing a single field (<samp class="ph codeph">json</samp>) with the value of
                    <samp class="ph codeph">value</samp>.</p>

            <div class="note note"><span class="notetitle">Note:</span> The following example assumes the cbc command is being executed on one of the
                cluster nodes. If run on another machine, refer to the <a class="xref" href="connecting.html#concept_fbg_xjm_zs">documentation</a> to see how to
                specify the cluster address.</div>

            <pre class="pre screen"># When storing JSON data using cbc, ensure it is properly quoted for your shell:
$ cbc create docid -V '{"json":"value"}' -M upsert
docid               Stored. CAS=0x8234c3c0f213</pre>

            <div class="p">You can also specify additional options when storing a document in Couchbase<ul class="ul" id="devguide_kvcore_generic__ul_gfq_mhg_45">
                    <li class="li"><a class="xref" href="expiry.html#concept_o53_kps_zs">TTL</a> or Expiry value which
                        will instruct the server to delete the document after a given amount of
                        time. This option is useful for transient data (such as sessions). By
                        default documents do not expire. See <a class="xref" href="expiry.html#concept_o53_kps_zs">TTL</a> for more information on
                        expiration.</li>

                    <li class="li"><a class="xref" href="cas-concurrency.html#concept_iq4_bts_zs">CAS</a> value to
                        protect against concurrent updates to the same document. See <a class="xref" href="cas-concurrency.html#concept_iq4_bts_zs">CAS</a> for a
                        description on how to use CAS values in your application.</li>

                    <li class="li"><a class="xref" href="durability.html#concept_gyg_14s_zs">Persistence and replication
                            requirements</a>.</li>

                </ul>
</div>

        </div>

        <div class="section" id="devguide_kvcore_generic__devguide_kvcore_get_generic"><h2 class="title sectiontitle">Retrieving documents</h2><div class="note note"><span class="notetitle">Note:</span> This section discusses retrieving
                documents using their IDs, or primary keys. Documents can also be accessed using
                secondary lookups via <a class="xref" href="querying.html" title="You can retrieve sets of information from Couchbase Server by using view queries or N1QL queries.">Query</a> and MapReduce. Primary
                key lookups are performed using the key-value API, which simplifies use and
                increases performance (as applications may interact with the KV store directly,
                rather than a secondary index or query processor).</div>
<div class="p">In Couchbase, documents
                are stored with their IDs. Retrieving a document via its ID is the simplest and
                quickest operation in
                Couchbase.<pre class="pre screen">&gt;&gt;&gt; result = cb.get('docid')
&gt;&gt;&gt; print result.value
{'json': 'value'}</pre>
</div>
<pre class="pre codeblock">$ cbc cat docid
docid                CAS=0x8234c3c0f213, Flags=0x0. Size=16
{"json":"value"}</pre>
<p class="p">Once
                a document is retrieved, it is accessible in the native format by which it was
                stored; meaning that if you stored the document as a list then the document is now
                available as a list again. The SDK will automatically deserialize the document from
                its stored format (usually JSON) to a native language type. It is possible to store
                and retrieve non-JSON documents as well, using a <a class="xref" href="google.cmo" target="_blank">transcoder</a></p>
<p class="p">You can also modify a
                document's expiration time while retrieving it; this is known as
                    <em class="ph i">get-and-touch</em> and allows you to keep temporary data alive while
                retrieving it in one atomic and efficient operation.</p>
Documents can also be
            retrieved with N1QL. While N1QL is generally used for secondary queries, it can also be
            used to retrieve documents by their primary keys (ID) (though it is recommended to use
            the key-value API if the ID is known). Lookups may be done either by comparing the
                <samp class="ph codeph">META(from-term).id</samp> or by using the <samp class="ph codeph">USE KEYS</samp> [...]
            keyword:
            <pre class="pre codeblock">SELECT * FROM default USE KEYS ["docid"];</pre>
or<pre class="pre codeblock">SELECT * FROM default WHERE META(default).id = "docid";</pre>
</div>

        <div class="section" id="devguide_kvcore_generic__devguide_kvcore_counter_generic"><h2 class="title sectiontitle">Counters</h2><p class="p">You can atomically increment or decrement the numerical
                value of special counter document </p>
A document may be used as a counter if its
            value is a simple ASCII number, like <samp class="ph codeph">42</samp>. Couchbase allows you to
            atomically increment and decrement these values using a special
                <span class="keyword apiname">counter</span> operation. The example below (in Python) shows how to use
            counters:<pre class="pre codeblock">&gt;&gt;&gt; cb.counter('counter_id', delta=20, initial=100).value
100L
&gt;&gt;&gt; cb.counter('counter_id', delta=1).value
101L
&gt;&gt;&gt; cb.counter('counter_id', delta=-50).value
51L</pre>
In
            the above example, a counter is created by using the <span class="keyword apiname">counter</span> Python
            method with an <span class="keyword parmname">initial</span> value. The initial value is the value the
            counter uses if the counter ID does not yet exist.<p class="p">Once created, the counter can be
                incremented or decremented atomically by a given <em class="ph i">amount</em> or <em class="ph i">delta</em>.
                Specifying a positive delta increments the value and specifying a negative one
                decrements it. When a counter operation is complete, the application receives the
                current value of the counter, after the increment.</p>
<p class="p">Couchbase counters are
                64-bit unsigned integers in Couchbase, and do not wrap around if decremented beyond
                0, however they will wrap around if incremented past their maximum value (which is
                the maximum value contained within a 64 bit integer). Many SDKs will limit the
                    <em class="ph i">delta</em> argument to the value of a <em class="ph i">signed</em> 64 bit
                    integer.</p>
<p class="p"><a class="xref" href="expiry.html#concept_o53_kps_zs">Expiration</a>
                times can also be specified when using counter operations.</p>
<div class="p"><a class="xref" href="cas-concurrency.html#concept_iq4_bts_zs">CAS</a> values are not used
                with counter operations since counter operations are atomic. The intent of the
                counter operation is to simply increment the current server-side value of the
                document. If you wish to only increment the document if it is at a certain value,
                then you may use a normal <span class="keyword apiname">upsert</span> function with
                CAS:<pre class="pre codeblock language-python">rv = cb.get(<span class="hl-string" style="color:#2a00ff">'counter_id'</span>)
value, cas = rv.value, rv.cas
<strong class="hl-keyword" style="color:#7f0055">if</strong> should_increment_value(value):
  cb.upsert(<span class="hl-string" style="color:#2a00ff">'counter_id'</span>, value + increment_amount, cas=cas)</pre>
</div>
</div>

        <div class="section" id="devguide_kvcore_generic__devguide_kvcore_append_prepend_generic"><h2 class="title sectiontitle">Raw byte concatenation</h2><div class="note hazardstatement note"><span class="notetitle">Note:</span> 
                <ul class="ul messagepanel" id="devguide_kvcore_generic__messagepanel_xx2_btg_vt">
                    <li class="li typeofhazard">These methods should not be used with JSON
                        documents</li>

                    <li class="li howtoavoid">The append and prepend operations operate at the byte level and are
                        unsuitable for dealing with JSON documents. Use these methods only when
                        explicitly dealing with binary or UTF-8 documents. Using the append and
                        prepend methods may invalidate an existing JSON document.</li>

                </ul>

            </div>
<pre class="pre codeblock">append(docid, fragment)
prepend(docid, fragment)</pre>
<p class="p">The
                    <em class="ph i">append</em> and <em class="ph i">prepend</em> operations atomically add bytes to the end or
                beginning of a binary document. They are an efficient alternative to retrieving a
                binary document in its entirety, appending the contents locally, and then saving the
                contents back to the server.</p>
<p class="p">Because these methods do raw string manipulation,
                they are only suitable for non-JSON documents: Prepending or appending anything to a
                JSON document will invalidate the JSON and make it unparseable by standard JSON
                parsers.</p>
<p class="p">The semantics of the <em class="ph i">append</em> and <em class="ph i">prepend</em> operations are
                similar to those of the <em class="ph i">upsert</em> family of operations, except that they accept
                the fragment to append as their value, rather than the entire document. These
                functions may be used to add efficiency for custom binary data structures (such as
                logs), as they avoid transferring the contents of the entire document for each
                operation. Consider the following versions (which are
                equivalent)</p>
<div class="p"><div style="margin-bottom: 0;"><strong>Append using get() and replace() (slow)</strong></div><pre class="pre codeblock language-python"><strong class="hl-keyword" style="color:#7f0055">import</strong> couchbase
<strong class="hl-keyword" style="color:#7f0055">import</strong> couchbase.exceptions
<strong class="hl-keyword" style="color:#7f0055">import</strong> couchbase.bucket

cb = couchbase.bucket.Bucket(<span class="hl-string" style="color:#2a00ff">'couchbase://10.0.0.31/default'</span>)
<em class="hl-comment" style="color:#006400"># Store the document</em>
cb.upsert(<span class="hl-string" style="color:#2a00ff">'binary_doc'</span>, <span class="hl-string" style="color:#2a00ff">'\x01'</span>, format=couchbase.FMT_BYTES)

<strong class="hl-keyword" style="color:#7f0055">while</strong> True:
    <em class="hl-comment" style="color:#006400"># Retrieve the entire document</em>
    rv = cb.get(<span class="hl-string" style="color:#2a00ff">'binary_doc'</span>)
    value = rv.value + <span class="hl-string" style="color:#2a00ff">'\x02'</span>
    <strong class="hl-keyword" style="color:#7f0055">try</strong>:
        <em class="hl-comment" style="color:#006400"># Upload the entire document</em>
        cb.replace(<span class="hl-string" style="color:#2a00ff">'binary_doc'</span>, value, format=couchbase.FMT_BYTES)
        <strong class="hl-keyword" style="color:#7f0055">break</strong>
    <strong class="hl-keyword" style="color:#7f0055">except</strong> couchbase.exceptions.KeyExistsError:
        <strong class="hl-keyword" style="color:#7f0055">continue</strong>

<strong class="hl-keyword" style="color:#7f0055">print</strong> repr(cb.get(<span class="hl-string" style="color:#2a00ff">'binary_doc'</span>).value)</pre>
<div style="margin-bottom: 0;"><strong>Append using append() (fast)</strong></div><pre class="pre codeblock language-python"><strong class="hl-keyword" style="color:#7f0055">import</strong> couchbase
<strong class="hl-keyword" style="color:#7f0055">import</strong> couchbase.exceptions
<strong class="hl-keyword" style="color:#7f0055">import</strong> couchbase.bucket

cb = couchbase.bucket.Bucket(<span class="hl-string" style="color:#2a00ff">'couchbase://10.0.0.31/default'</span>)
<em class="hl-comment" style="color:#006400"># Store the document</em>
cb.upsert(<span class="hl-string" style="color:#2a00ff">'binary_doc'</span>, <span class="hl-string" style="color:#2a00ff">'\x01'</span>, format=couchbase.FMT_BYTES)

<em class="hl-comment" style="color:#006400"># Append a fragment</em>
cb.append(<span class="hl-string" style="color:#2a00ff">'binary_doc'</span>, <span class="hl-string" style="color:#2a00ff">'\x02'</span>, format=couchbase.FMT_BYTES)

<strong class="hl-keyword" style="color:#7f0055">print</strong> repr(cb.get(<span class="hl-string" style="color:#2a00ff">'binary_doc'</span>).value)</pre>
Note
                that since the <em class="ph i">append</em> operation is done atomically, there is no need for a
                CAS check (though one can still be supplied if the document must be at a specific
                state).</div>
Users of the <em class="ph i">append</em> and <em class="ph i">prepend</em> operations should ensure
            that the resulting documents do not become too large. Couchbase has a hard document size
            limit of 20MB.<p class="p">Using <em class="ph i">append</em> and <em class="ph i">prepend</em> on larger documents may cause
                performance degradation and memory fragmentation at the server level, as for each
                append operation the server must allocate memory for the new document size and then
                append the fragment to the new memory. The performance impact may be significant
                when document sizes reach beyond 100KB.</p>
<p class="p">Finally, note that while append saves
                network traffic from the client to server (by only specifying the fragment to
                append), the entire document is replicated for each mutation. Five append operations
                on a single 10MB document will result in 50MB of traffic to each
            replica.</p>
</div>

    </div>

<div class="related-links"></div>
<div class="navfooter"><!---->
<span class="navparent"><a class="link" href="managing-data.html" title="Managing Data"><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Managing Data</span></a></span>  </div><div class="footer">WebHelp output generated by<a href="http://www.oxygenxml.com" target="_blank"><span class="oXygenLogo"><img src="oxygen-webhelp/resources/img/LogoOxygen100x22.png" alt="Oxygen"></img></span><span class="xmlauthor">XML Author</span></a> - Trial Edition</div>
</body>
</html>