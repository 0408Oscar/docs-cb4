
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
<head><meta name="description" content="Most operations return an lcb_error_t status code. A successful operation is defined by the return code of LCB_SUCCESS , while any other code indicates an error condition. You can find a full list of ..."></meta><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><meta name="copyright" content="(C) Copyright 2005"></meta><meta name="DC.rights.owner" content="(C) Copyright 2005"></meta><meta name="DC.Type" content="concept"></meta><meta name="DC.Title" content="Handling errors"></meta><meta name="abstract" content="Most operations return an lcb_error_t status code."></meta><meta name="description" content="Most operations return an lcb_error_t status code."></meta><meta name="DC.Relation" scheme="URI" content="c-intro.html"></meta><meta name="DC.Relation" scheme="URI" content="managing-connections.html"></meta><meta name="DC.Relation" scheme="URI" content="preempting-errors.html"></meta><meta name="DC.Relation" scheme="URI" content="preempting-errors.html"></meta><meta name="DC.Format" content="XHTML"></meta><meta name="DC.Identifier" content="concept_vqw_djq_44"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>Handling errors</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/skins/skin.css"><!----></link><script type="text/javascript"><!--
          
          var prefix = "index.html";
          
          --></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-1.8.2.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script></head>
<body onload="highlightSearchTerm()" class="frmBody" id="concept_vqw_djq_44">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><a href="javascript:window.print();" title="Print this page"></a></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td width="75%"><a class="navheader_parent_path" href="c-intro.html" title="C SDK 2.6">C SDK 2.6</a></td><td><div class="navheader">
<span class="navparent"><a class="link" href="c-intro.html" title="C SDK 2.6"><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">C SDK 2.6</span></a></span>  
<span class="navprev"><a class="link" href="managing-connections.html" title="This section will guide you through the process and steps of configuring the client to talk to a variety of cluster setups and options."><span class="navheader_label">Previous topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Managing server connections</span></a></span>  
<span class="navnext"><a class="link" href="preempting-errors.html" title="If a server is known to be down by the application, the application may utilize some of the library's APIs to avoid sending keys mapped to that server."><span class="navheader_label">Next topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Preempting errors from bad servers</span></a></span>  </div></td></tr></tbody></table>

	<h1 class="title topictitle1">Handling errors</h1>

	
<div class="body conbody"><p class="shortdesc">Most operations return an <samp class="ph codeph">lcb_error_t</samp> status code.</p>

		<p class="p"> A successful operation
			is defined by the return code of <samp class="ph codeph">LCB_SUCCESS</samp>, while any other code
			indicates an error condition. You can find a full list of error codes in the
				<span class="ph filepath">&lt;libcouchbase/error.h&gt;</span> header.</p>

		<div class="note note"><span class="notetitle">Note:</span> New applications are advised to enable extended error codes by using the
				<samp class="ph codeph">LCB_CNTL_DETAILED_ERRCODES</samp> setting (see <a class="xref" href="tuning.html#concept_wtt_2jq_44" title="You can change library defaults and behavior to better adapt to your application.">Tuning and configuring</a>). 
			Extended error codes are not enabled by default to avoid sending older applications error codes that they cannot handle.
			</div>

		<p class="p">To handle the errors properly, you must understand what the errors mean and whether they
			indicate a data error, that the operation can be retried, or a fatal
			error.</p>

		<div class="p"><dfn class="term">Data errors</dfn> are errors received from the cluster as a result of a requested
			operation on a given item. For example, if an <span class="keyword apiname">lcb_get()</span> is performed on
			a key that does not exist, the callback will receive an <samp class="ph codeph">LCB_KEY_ENOENT</samp>
			error. Other examples of conditions that can result in data errors include: <ul class="ul" id="concept_vqw_djq_44__ul_r1n_3qj_p4">
				<li class="li">Adding a key that already exists (An <samp class="ph codeph">LCB_KEY_EEXISTS</samp>) will be
					thrown</li>

				<li class="li">Replacing a key that does not already exist (<samp class="ph codeph">LCB_KEY_ENOENT</samp>)</li>

				<li class="li">Appending, prepending, or incrementing an item that does not already exist
						(<samp class="ph codeph">LCB_KEY_ENOENT</samp>, <samp class="ph codeph">LCB_NOT_STORED</samp>)</li>

				<li class="li">Modifying an item while specifying a CAS, where the CAS on the server has already
					been modified (<samp class="ph codeph">LCB_KEY_EEXISTS</samp>).</li>

			</ul>
</div>

		<div class="p">Environmental errors related to load or network issues might be received in exceptional
			conditions. Although you should not receive these types of errors in normal,
			well-provisioned deployments, your application must be prepared to handle them and take
			proper action. Environmental errors are divided into the following subgroups:<ul class="ul" id="concept_vqw_djq_44__ul_tsw_rrj_p4">
				<li class="li"><strong class="ph b">Transient</strong>. This error type indicates an environment and/or resource
					limitation either on the server or on the network link between the client and the
					server. Examples of transient errors include timeout errors or temporary failures
					such as <samp class="ph codeph">LCB_ETIMEDOUT</samp> (took too long to get a reply) and
						<samp class="ph codeph">LCB_ETMPFAIL</samp> (server was too busy). Transient errors are
					typically best handled on the application side by backing off and retrying the
					operation, with the intent of reducing stress on the exhausted resource. Some
					examples of transient error causes: <ul class="ul" id="concept_vqw_djq_44__ul_ut2_vrj_p4">
						<li class="li">Insufficient cache memory on the server</li>

						<li class="li">Overutilization of the network link between the client and server or between
							several servers</li>

						<li class="li">Router or switch failure</li>

						<li class="li">Failover of a node</li>

						<li class="li">Overutilization of application-side CPU.</li>

					</ul>
</li>

				<li class="li"><strong class="ph b">Fatal</strong>. This error type indicates that the client has potentially entered into
					an irrecoverable failed state, either because of invalid user input (or client
					configuration), or because an administrator has modified settings on the cluster (for
					example, a bucket has been removed). Examples of fatal errors include
						<samp class="ph codeph">LCB_AUTH_ERROR</samp> (authentication failed) and
						<samp class="ph codeph">LCB_BUCKET_ENOENT</samp> (bucket does not exist).<p class="p">Fatal errors
						typically require inspection of the client configuration and a restart of the
						client application or a reversal of the change performed at the cluster. Some
						examples of fatal error causes:</p>
<ul class="ul" id="concept_vqw_djq_44__ul_yhb_hsj_p4">
						<li class="li">Bucket does not exist.</li>

						<li class="li">Bucket password is wrong.</li>

						<li class="li">None of the nodes in the cluster are reachable.</li>

					</ul>
</li>

			</ul>
</div>

		<div class="p">The lcb_errflags_t enumeration defines a set of flags that are associated with each error
			code. These flags define the type of error. Some examples of error types: <ul class="ul" id="concept_vqw_djq_44__ul_jmb_gtj_p4">
				<li class="li"><samp class="ph codeph">LCB_ERRTYPE_INPUT</samp>, which is set when a malformed parameter is
					passed to the library</li>

				<li class="li"><samp class="ph codeph">LCB_ERRTYPE_DATAOP</samp>, which is set when the server is unable to
					satisfy data constraints such as a missing key or a CAS mismatch.</li>

			</ul>
</div>

		<div class="p">The <samp class="ph codeph">LCB_EIF_${TYPE}</samp> macros, where <samp class="ph codeph">${TYPE}</samp> represents one
			of the <samp class="ph codeph">lcb_errflags_t</samp> flags, can be used to check whether an error is of a
			specific type. The following example shows how to check the return codes:
			<pre class="pre codeblock language-c"><strong class="hl-keyword" style="color:#7f0055">static</strong> <strong class="hl-keyword" style="color:#7f0055">void</strong> get_callback(lcb_t instance,
  <strong class="hl-keyword" style="color:#7f0055">const</strong> <strong class="hl-keyword" style="color:#7f0055">void</strong> *cookie, lcb_error_t err, <strong class="hl-keyword" style="color:#7f0055">const</strong> lcb_get_resp_t *resp)
{
  <strong class="hl-keyword" style="color:#7f0055">if</strong> (err == LCB_SUCCESS) {
    printf(<span class="hl-string" style="color:#2a00ff">"Successfuly retrieved key!\n"</span>);
  } <strong class="hl-keyword" style="color:#7f0055">else</strong> <strong class="hl-keyword" style="color:#7f0055">if</strong> (LCB_EIFDATA(err)) {
    <strong class="hl-keyword" style="color:#7f0055">switch</strong> (err) {
    <strong class="hl-keyword" style="color:#7f0055">case</strong> LCB_KEY_ENOENT:
      printf(<span class="hl-string" style="color:#2a00ff">"Key not found!\n"</span>);
      <strong class="hl-keyword" style="color:#7f0055">break</strong>;
    <strong class="hl-keyword" style="color:#7f0055">default</strong>:
      printf(<span class="hl-string" style="color:#2a00ff">"Received other unhandled data error\n"</span>);
      <strong class="hl-keyword" style="color:#7f0055">break</strong>;
    }
  } <strong class="hl-keyword" style="color:#7f0055">else</strong> <strong class="hl-keyword" style="color:#7f0055">if</strong> (LCB_EIFTMP(err)) {
    printf(<span class="hl-string" style="color:#2a00ff">"Transient error received. May retry\n"</span>);
  }
}</pre>
</div>

		<div class="section"><h2 class="title sectiontitle">When to check for errors, and what they mean</h2>
			
			<p class="p">Success and failure depend on the context. A successful return code for one of the data
				operation APIs (for example, <span class="keyword apiname">lcb_store()</span>) does not mean the operation
				itself succeeded and the key was successfully stored. Rather, it means the key was
				successfully placed inside the library’s internal queue. The actual error code is
				delivered as the <samp class="ph codeph">error</samp> parameter in the operation callback itself (that
				is, the callback installed with <span class="keyword apiname">lcb_set_storage_callback()</span>).</p>

			<p class="p">Errors received as a return value from a scheduling function (i.e. <samp class="ph codeph">lcb_get()</samp>)
				will fail only if there is an issue with the cluster (that is, a node was failed over
				and there is no replica at that position), or if invalid input was specified to the
				library. Errors received in the callback will either be data responses from the server
				or environmental errors (such as an error that took place while reading from the
				network).</p>

			<p class="p">If a scheduling API returns anything but <samp class="ph codeph">LCB_SUCCESS</samp>, the callback for
				that specific request will <em class="ph i">not</em> be delivered. Conversely, it is guaranteed that
				the callback will always be delivered if the return code for the scheduling function is
					<samp class="ph codeph">LCB_SUCCESS</samp>.</p>

		</div>

		<div class="section"><h2 class="title sectiontitle">Program crashes and pitfalls</h2>
			
			<div class="p">If your application abnormally terminates while invoking a function with the library, you may
				have either encountered a bug or passed the library an invalid pointer. Keep in mind the
				following points:<ul class="ul" id="concept_vqw_djq_44__ul_dyk_2vj_p4">
					<li class="li">The library is <em class="ph i">not</em> thread safe. While you may use multiple <em class="ph i">lcb_t</em>
						handles in different threads, you must never access the same handle from multiple
						threads without using external synchronization functions (such as mutexes).</li>

					<li class="li">The response structures within the callback are valid <em class="ph i">only</em> in the scope of
						the callback function itself. This means you must copy the structure (and any
						contained keys and values) into another location in memory if you wish to use it
						outside the callback.</li>

					<li class="li">Callbacks will <em class="ph i">not</em> be invoked if the scheduling function returns a failure
						status. This means that the following code will result in accessing uninitialized
						memory:<pre class="pre codeblock language-c"><strong class="hl-keyword" style="color:#7f0055">struct</strong> myresult {
  <strong class="hl-keyword" style="color:#7f0055">char</strong> *value;
  lcb_error_t err;
}
<strong class="hl-keyword" style="color:#7f0055">static</strong> <strong class="hl-keyword" style="color:#7f0055">void</strong> get_callback(lcb_t instance, <strong class="hl-keyword" style="color:#7f0055">const</strong> <strong class="hl-keyword" style="color:#7f0055">void</strong> *cookie,
    lcb_error_t err, <strong class="hl-keyword" style="color:#7f0055">const</strong> lcb_get_resp_t *resp)
{
  <strong class="hl-keyword" style="color:#7f0055">struct</strong> myresult *mr = (<strong class="hl-keyword" style="color:#7f0055">struct</strong> myresult *)cookie;
  mr-&gt;err = err;
  <strong class="hl-keyword" style="color:#7f0055">if</strong> (mr-&gt;err == LCB_SUCCESS) {
    mr-&gt;value = malloc(resp-&gt;v.v0.nkey + <span class="hl-number">1</span>);
    memcpy(mr-&gt;value, resp-&gt;v.v0.key, resp-&gt;v.v0.nkey);
    mr-&gt;value[resp-&gt;v.v0.nkey] = <span class="hl-string" style="color:#2a00ff">'\0'</span>;
  } <strong class="hl-keyword" style="color:#7f0055">else</strong> {
    mr-&gt;value = NULL;
  }
}

<em class="hl-comment" style="color:#006400">// Some lines later</em>
<strong class="hl-keyword" style="color:#7f0055">struct</strong> myresult mr;
lcb_get(instance, &amp;mr, <span class="hl-number">1</span>, &amp;cmdlist);
lcb_wait(instance);
<strong class="hl-keyword" style="color:#7f0055">if</strong> (mr.value) {
  <em class="hl-comment" style="color:#006400">// If lcb_get() returned an error, this will be uninitialized access!</em>
  <em class="hl-comment" style="color:#006400">// ...</em>
}</pre>
</li>

				</ul>
</div>

			<p class="p">A crash can also be a result of a bug in the library. Sometimes the library will call abort
				when it detects an inconsistent state. If you think you have found a bug in the library
				you should file a bug in our <a class="xref" href="http://www.couchbase.com/issues/browse/CCBC" target="_blank">issue tracker</a>. When filing a bug, please be
				sure to include the library version and any relevant code samples.</p>

		</div>

		<div class="section"><h2 class="title sectiontitle">Diagnosing Issues</h2>
			
			<p class="p">Diagnosing issues can typically be done by enabling logging (see <a class="xref" href="logging.html#concept_ff3_2jq_44" title="The library offers basic functionality for logging to the program's standard error stream.">Setting up logging</a>).</p>

		</div>

	</div>

<div class="related-links">
<ul class="ullinks">
<li class="link ulchildlink"><strong><a href="preempting-errors.html">Preempting errors from bad servers</a></strong><br></br>
If a server is known to be down by the application, the application may utilize some of         the library's APIs to avoid sending keys mapped to that server.</li>
</ul>
</div>
<div class="navfooter"><!---->
<span class="navparent"><a class="link" href="c-intro.html" title="C SDK 2.6"><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">C SDK 2.6</span></a></span>  
<span class="navprev"><a class="link" href="managing-connections.html" title="This section will guide you through the process and steps of configuring the client to talk to a variety of cluster setups and options."><span class="navheader_label">Previous topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Managing server connections</span></a></span>  
<span class="navnext"><a class="link" href="preempting-errors.html" title="If a server is known to be down by the application, the application may utilize some of the library's APIs to avoid sending keys mapped to that server."><span class="navheader_label">Next topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Preempting errors from bad servers</span></a></span>  </div><div class="footer">WebHelp output generated by<a href="http://www.oxygenxml.com" target="_blank"><span class="oXygenLogo"><img src="oxygen-webhelp/resources/img/LogoOxygen100x22.png" alt="Oxygen"></img></span><span class="xmlauthor">XML Author</span></a> - Trial Edition</div>
</body>
</html>