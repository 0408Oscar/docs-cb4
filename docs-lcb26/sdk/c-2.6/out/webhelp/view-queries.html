
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
<head><meta name="description" content="You can use MapReduce views to create queryable secondary indexes in Couchbase Server. The primary index for documents is the key you use when performing the standard CRUD methods. In the C client ..."></meta><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><meta name="copyright" content="(C) Copyright 2005"></meta><meta name="DC.rights.owner" content="(C) Copyright 2005"></meta><meta name="DC.Type" content="concept"></meta><meta name="DC.Title" content="Working with view queries"></meta><meta name="abstract" content="You can use MapReduce views to create queryable secondary indexes in Couchbase Server."></meta><meta name="description" content="You can use MapReduce views to create queryable secondary indexes in Couchbase Server."></meta><meta name="DC.Relation" scheme="URI" content="querying.html"></meta><meta name="DC.Format" content="XHTML"></meta><meta name="DC.Identifier" content="concept_tvx_nhq_44"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>Working with view queries</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/skins/skin.css"><!----></link><script type="text/javascript"><!--
          
          var prefix = "index.html";
          
          --></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-1.8.2.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script></head>
<body onload="highlightSearchTerm()" class="frmBody" id="concept_tvx_nhq_44">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><a href="javascript:window.print();" title="Print this page"></a></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td width="75%"><a class="navheader_parent_path" href="c-intro.html" title="C SDK 2.6">C SDK 2.6</a> / <a class="navheader_parent_path" href="querying.html" title="You can retrieve sets of information from Couchbase Server by using view queries or N1QL queries.">Querying buckets</a></td><td><div class="navheader">
<span class="navparent"><a class="link" href="querying.html" title="You can retrieve sets of information from Couchbase Server by using view queries or N1QL queries."><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Querying buckets</span></a></span>  </div></td></tr></tbody></table>

    <h1 class="title topictitle1">Working with view queries</h1>

    
    <div class="body conbody"><p class="shortdesc">You can use MapReduce views to create queryable secondary indexes in Couchbase
        Server. </p>

        <p class="p">The primary index for documents is the key you use when performing the standard CRUD
			methods. In the C client library, query results are delivered on a per-row basis to a given
			callback, which is specified at query time.</p>

        <p class="p">The following example queries a <samp class="ph codeph">by_name</samp> view in a beer design document.
            This view checks whether a document is a beer and has a name. If it does, it emits the
            beer's name into the index. This view allows beers to be queried for by name. For
            example, it's now possible to ask the question "What beers start with A?"</p>

        <pre class="pre codeblock language-javascript"><strong class="hl-keyword" style="color:#7f0055">function</strong> (doc, meta) {
  <strong class="hl-keyword" style="color:#7f0055">if</strong> (doc.type &amp;&amp; doc.type == <span class="hl-string" style="color:#2a00ff">"beer"</span> &amp;&amp; doc.name) {
     emit(doc.name, null);
  }
}</pre>

        <p class="p">Querying a view is performed through the <span class="keyword apiname">lcb_view_query()</span> function. To
			use this function, include the <span class="ph filepath">&lt;libcouchbase/views.h&gt;</span> file.</p>

        <p class="p">First, a handler function is defined to deal with each row (and at the end, any metadata)
            of the query:</p>

        <div class="p"><div style="margin-bottom: 0;"><strong>Per-Row callback</strong></div><pre class="pre codeblock language-c"><strong class="hl-keyword" style="color:#7f0055">static</strong> <strong class="hl-keyword" style="color:#7f0055">void</strong> viewCallback(lcb_t instance, <strong class="hl-keyword" style="color:#7f0055">int</strong> ign, <strong class="hl-keyword" style="color:#7f0055">const</strong> lcb_RESPVIEWQUERY *rv)
{
    <strong class="hl-keyword" style="color:#7f0055">if</strong> (rv-&gt;rflags &amp; LCB_RESP_F_FINAL) {
        printf(<span class="hl-string" style="color:#2a00ff">"*** META FROM VIEWS ***\n"</span>);
        fprintf(stderr, <span class="hl-string" style="color:#2a00ff">"%.*s\n"</span>, (<strong class="hl-keyword" style="color:#7f0055">int</strong>)rv-&gt;nvalue, rv-&gt;value);
        <strong class="hl-keyword" style="color:#7f0055">return</strong>;
    }

    printf(<span class="hl-string" style="color:#2a00ff">"Got row callback from LCB: RC=0x%X, DOCID=%.*s. KEY=%.*s\n"</span>,
        rv-&gt;rc,
        (<strong class="hl-keyword" style="color:#7f0055">int</strong>)rv-&gt;ndocid, rv-&gt;docid,
        (<strong class="hl-keyword" style="color:#7f0055">int</strong>)rv-&gt;nkey, rv-&gt;key);

    <strong class="hl-keyword" style="color:#7f0055">if</strong> (rv-&gt;docresp) {
        printf(<span class="hl-string" style="color:#2a00ff">"   Document for response. RC=0x%X. CAS=0x%lx\n"</span>,
            rv-&gt;docresp-&gt;rc, rv-&gt;docresp-&gt;cas);
    }
}
</pre>
This
			callback is invoked for each row. The end of the query (when no more rows to return) is
			signaled by having the <samp class="ph codeph">LCB_RESP_F_FINAL</samp> bit set in the response's
				<samp class="ph codeph">rflags</samp> field.</div>

        <p class="p">The response structure contains a <samp class="ph codeph">key</samp> and <samp class="ph codeph">nkey</samp>,
				<samp class="ph codeph">value</samp> and <samp class="ph codeph">nvalue</samp>, and <samp class="ph codeph">docid</samp> and
				<samp class="ph codeph">ndodic</samp> fields that contain the buffer and lengths for the emitted keys
			and values of the view result and the corresponding document ID. The final row (the one
			with the <samp class="ph codeph">LCB_RESP_F_FINAL</samp> flag set) contains the "shell" of the response
			(that is, any errors, debug information, and the <samp class="ph codeph">total_rows</samp> field) in the
				<samp class="ph codeph">value</samp> field.</p>

        <p class="p">All the fields (except <samp class="ph codeph">docid</samp>) are JSON encoded and should be decoded by
            a JSON decoder before use.</p>

        <div class="p">To actually invoke the query, populate the request
            structure:<pre class="pre codeblock language-c">lcb_CMDVIEWQUERY vq = { <span class="hl-number">0</span> };
lcb_view_query_initcmd(&amp;vq, <span class="hl-string" style="color:#2a00ff">"beer"</span>, <span class="hl-string" style="color:#2a00ff">"by_name"</span>, NULL, viewCallback);
lcb_error_t rc = lcb_view_query(instance, NULL, &amp;vq);
<strong class="hl-keyword" style="color:#7f0055">if</strong> (rc != LCB_SUCCESS) {
    <em class="hl-comment" style="color:#006400">// Handle error</em>
}
lcb_wait(instance);</pre>
The
                <span class="keyword apiname">lcb_view_query_initcmd()</span> convenience function allows you to
            populate the command structure with common parameters. Unlike most library operations,
            the callback here is specific to the operation rather than global.</div>

        <p class="p">Of course, the command structure can also be populated manually:</p>

        <pre class="pre codeblock language-c">lcb_CMDVIEWQUERY vq = { <span class="hl-number">0</span> };
vq.ddoc = <span class="hl-string" style="color:#2a00ff">"beer"</span>;
vq.nddoc = strlen(vq.ddoc);
vq.view = <span class="hl-string" style="color:#2a00ff">"by_name"</span>;
vq.nview = strlen(vq.view);
vq.callback = viewCallback;
lcb_error_t rc = lcb_view_query(instance, NULL, &amp;vq);
<strong class="hl-keyword" style="color:#7f0055">if</strong> (rc != LCB_SUCCESS) {
    <em class="hl-comment" style="color:#006400">// ...</em>
}
lcb_wait(instance);</pre>

    </div>

<div class="related-links"></div>
<div class="navfooter"><!---->
<span class="navparent"><a class="link" href="querying.html" title="You can retrieve sets of information from Couchbase Server by using view queries or N1QL queries."><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Querying buckets</span></a></span>  </div><div class="footer">WebHelp output generated by<a href="http://www.oxygenxml.com" target="_blank"><span class="oXygenLogo"><img src="oxygen-webhelp/resources/img/LogoOxygen100x22.png" alt="Oxygen"></img></span><span class="xmlauthor">XML Author</span></a> - Trial Edition</div>
</body>
</html>