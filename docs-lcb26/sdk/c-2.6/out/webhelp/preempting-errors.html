
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
<head><meta name="description" content="If a server is known to be down by the application, the application may utilize some of the library's APIs to avoid sending keys mapped to that server. In Couchbase architecture, keys are mapped to ..."></meta><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><meta name="copyright" content="(C) Copyright 2005"></meta><meta name="DC.rights.owner" content="(C) Copyright 2005"></meta><meta name="DC.Type" content="concept"></meta><meta name="DC.Title" content="Preempting errors from bad servers"></meta><meta name="abstract" content="If a server is known to be down by the application, the application may utilize some of the library's APIs to avoid sending keys mapped to that server."></meta><meta name="description" content="If a server is known to be down by the application, the application may utilize some of the library's APIs to avoid sending keys mapped to that server."></meta><meta name="DC.Relation" scheme="URI" content="handling-errors.html"></meta><meta name="DC.Format" content="XHTML"></meta><meta name="DC.Identifier" content="concept_d1t_2wf_xt"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>Preempting errors from bad servers</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/skins/skin.css"><!----></link><script type="text/javascript"><!--
          
          var prefix = "index.html";
          
          --></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-1.8.2.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script></head>
<body onload="highlightSearchTerm()" class="frmBody" id="concept_d1t_2wf_xt">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><a href="javascript:window.print();" title="Print this page"></a></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td width="75%"><a class="navheader_parent_path" href="c-intro.html" title="C SDK 2.6">C SDK 2.6</a> / <a class="navheader_parent_path" href="handling-errors.html" title="Most operations return an lcb_error_t status code.">Handling errors</a></td><td><div class="navheader">
<span class="navparent"><a class="link" href="handling-errors.html" title="Most operations return an lcb_error_t status code."><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Handling errors</span></a></span>  </div></td></tr></tbody></table>

 <h1 class="title topictitle1">Preempting errors from bad servers</h1>

 
 <div class="body conbody"><p class="shortdesc">If a server is known to be down by the application, the application may utilize some of
        the library's APIs to avoid sending keys mapped to that server.</p>

        <p class="p">In Couchbase architecture, keys are mapped to [vBuckets], which in turn are mapped to
            cluster nodes. When an operation is scheduled for a given key, the key is placed in a
            queue to be sent to a specific server. If you know that a certain server is down or
            unavailable, you can avoid scheduling the operation and fail the request immediately by
            determining if the key's destination server is indeed a failed server.</p>

        <div class="p">In the C SDK the following steps should be used to determine the target host of a given
                key:<ol class="ol" id="concept_d1t_2wf_xt__ol_zwx_t3v_xt">
                <li class="li">Get the vBucket configuration object (via <span class="keyword apiname">lcb_cntl()</span>)</li>

                <li class="li">Map the key to a server index (via <span class="keyword apiname">lcbvb_map_key()</span>)</li>

                <li class="li">Get the <samp class="ph codeph">host:port</samp> of the data node hosting the given key (via
                        <span class="keyword apiname">lcb_get_node()</span> or
                    <span class="keyword apiname">lcbvb_get_hostport()</span>)</li>

                <li class="li">Strip the <samp class="ph codeph">:port</samp> from the string to yield the hostname of the
                    target server.</li>

            </ol>
</div>

        <div class="p">The following snippet shows how to do this in a single function (in
            C++)<pre class="pre codeblock language-cpp">    std::string hostForKey(lcb_t instance, <strong class="hl-keyword" style="color:#7f0055">const</strong> <strong class="hl-keyword" style="color:#7f0055">void</strong> *key, size_t nkey) {
        lcbvb_CONFIG *vbc;
        lcb_cntl(instance, LCB_CNTL_GET, LCB_CNTL_VBCONFIG, &amp;vbc);
        <strong class="hl-keyword" style="color:#7f0055">int</strong> vbid, server_index;
        lcbvb_map_key(vbc, key, nkey, &amp;vbid, &amp;server_index);

        <strong class="hl-keyword" style="color:#7f0055">if</strong> (server_index &lt; <span class="hl-number">0</span>) {
            <strong class="hl-keyword" style="color:#7f0055">return</strong> <span class="hl-string" style="color:#2a00ff">""</span>; <em class="hl-comment" style="color:#006400">// We want to trigger a config refresh</em>
        }

        <em class="hl-comment" style="color:#006400">// Find the server:</em>
        <strong class="hl-keyword" style="color:#7f0055">const</strong> <strong class="hl-keyword" style="color:#7f0055">char</strong> *server = lcb_get_node(instance, LCB_NODE_DATA, server_index);
        <strong class="hl-keyword" style="color:#7f0055">const</strong> <strong class="hl-keyword" style="color:#7f0055">char</strong> *endp = strchr(server, <span class="hl-string" style="color:#2a00ff">':'</span>);
        std::string host(server, endp);
        <strong class="hl-keyword" style="color:#7f0055">return</strong> host;
    }</pre>
</div>

    </div>

<div class="related-links"></div>
<div class="navfooter"><!---->
<span class="navparent"><a class="link" href="handling-errors.html" title="Most operations return an lcb_error_t status code."><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Handling errors</span></a></span>  </div><div class="footer">WebHelp output generated by<a href="http://www.oxygenxml.com" target="_blank"><span class="oXygenLogo"><img src="oxygen-webhelp/resources/img/LogoOxygen100x22.png" alt="Oxygen"></img></span><span class="xmlauthor">XML Author</span></a> - Trial Edition</div>
</body>
</html>